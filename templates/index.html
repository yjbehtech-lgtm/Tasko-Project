<!-- ===== templates/index.html (V4 ä¿®æ­£ç‰ˆ with å†·å´ä¸å‰©ä½™æ¬¡æ•°) ===== -->
{% extends "base.html" %}
{% block content %}
    <h1>ğŸ¯ Tasko Roll & Earn</h1>
    <p id="status">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è§‚çœ‹å¹¿å‘Šå¹¶è·å–ç§¯åˆ†</p>
    <button id="roll-btn" onclick="startAdCountdown()">è§‚çœ‹å¹¿å‘Šå¹¶ Roll</button>
    <div id="cooldown" style="margin-top: 10px;"></div>
    <div id="ad-countdown" style="margin-top: 10px; font-weight: bold;"></div>
    <div id="click-limit" style="margin-top: 10px; color: #ffcc00;"></div>

    <script>
        let cooldownSeconds = 60;
        let maxClicksPerDay = 20;

        window.onload = () => {
            fetchUserStatus();
        }

        function fetchUserStatus() {
            fetch('/api/user-status')
                .then(res => res.json())
                .then(data => {
                    document.getElementById("click-limit").innerText = `ä»Šæ—¥å·²ç‚¹å‡»ï¼š${data.clicks_today} / ${maxClicksPerDay}`;
                })
                .catch(() => {
                    document.getElementById("click-limit").innerText = "âš ï¸ æ— æ³•è·å–å‰©ä½™æ¬¡æ•°";
                });
        }

        function startAdCountdown() {
            const adDiv = document.getElementById("ad-countdown");
            const status = document.getElementById("status");
            const btn = document.getElementById("roll-btn");

            btn.disabled = true;
            status.innerText = "ğŸ“º æ­£åœ¨æ’­æ”¾å¹¿å‘Šï¼Œè¯·ç­‰å¾… 10 ç§’...";

            let secondsLeft = 10;
            adDiv.innerText = `å¹¿å‘Šå€’è®¡æ—¶ï¼š${secondsLeft} ç§’`;

            const adInterval = setInterval(() => {
                secondsLeft--;
                adDiv.innerText = `å¹¿å‘Šå€’è®¡æ—¶ï¼š${secondsLeft} ç§’`;

                if (secondsLeft <= 0) {
                    clearInterval(adInterval);
                    adDiv.innerText = "å¹¿å‘Šæ’­æ”¾ç»“æŸï¼æ­£åœ¨å‘æ”¾å¥–åŠ±...";
                    roll();
                }
            }, 1000);
        }

        function roll() {
            fetch('/click')
                .then(response => response.json())
                .then(data => {
                    const status = document.getElementById('status');
                    const cooldown = document.getElementById('cooldown');
                    const btn = document.getElementById('roll-btn');

                    fetchUserStatus(); // æ¯æ¬¡ roll ååˆ·æ–°å‰©ä½™æ¬¡æ•°

                    if (data.error) {
                        status.innerText = "âš ï¸ " + data.error;
                        btn.disabled = false;
                        document.getElementById("ad-countdown").innerText = "";
                        return;
                    }

                    let rewardText = "ğŸ‰ ä½ è·å¾—äº†ï¼š" + data.reward.join(" + ") + " åˆ†";
                    let luckyText = "ğŸ« å¹¸è¿å·ç ï¼š" + data.lucky_number;
                    status.innerText = rewardText + "\n" + luckyText;

                    cooldown.innerText = "å†·å´ä¸­ï¼š" + cooldownSeconds + " ç§’";
                    startCooldown(cooldownSeconds);
                })
                .catch(() => {
                    document.getElementById("status").innerText = "âŒ å¥–åŠ±è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚";
                    document.getElementById("roll-btn").disabled = false;
                });
        }

        function startCooldown(secondsLeft) {
            const cooldownDiv = document.getElementById('cooldown');
            const button = document.getElementById('roll-btn');

            button.disabled = true;
            cooldownDiv.style.display = 'block';

            const interval = setInterval(() => {
                secondsLeft--;
                cooldownDiv.innerText = `å†·å´ä¸­ï¼š${secondsLeft} ç§’`;

                if (secondsLeft <= 0) {
                    clearInterval(interval);
                    cooldownDiv.style.display = 'none';
                    document.getElementById('status').innerText = '';
                    document.getElementById('ad-countdown').innerText = '';
                    button.disabled = false;
                }
            }, 1000);
        }
    </script>
{% endblock %}
