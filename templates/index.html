<!-- ===== templates/index.html (V4 上半段版本) ===== -->
{% extends "base.html" %}
{% block content %}
    <h1>🎯 Tasko Roll & Earn</h1>
    <p id="result">点击下方按钮观看广告并获取积分</p>
    <button id="roll-btn" onclick="startAdCountdown()">观看广告并 Roll</button>
    <div id="cooldown" style="margin-top: 10px;"></div>
    <div id="ad-countdown" style="margin-top: 10px; font-weight: bold;"></div>

    <script>
        let cooldownSeconds = 60;

        function startAdCountdown() {
            const adDiv = document.getElementById("ad-countdown");
            const result = document.getElementById("result");
            const btn = document.getElementById("roll-btn");

            btn.disabled = true;
            result.innerText = "📺 正在播放广告，请等待 10 秒...";

            let secondsLeft = 10;
            adDiv.innerText = `广告倒计时：${secondsLeft} 秒`;

            const adInterval = setInterval(() => {
                secondsLeft--;
                adDiv.innerText = `广告倒计时：${secondsLeft} 秒`;

                if (secondsLeft <= 0) {
                    clearInterval(adInterval);
                    adDiv.innerText = "广告播放结束！正在发放奖励...";
                    roll();
                }
            }, 1000);
        }

        function roll() {
            fetch('/click')
                .then(response => response.json())
                .then(data => {
                    const result = document.getElementById('result');
                    const cooldown = document.getElementById('cooldown');
                    const btn = document.getElementById('roll-btn');

                    if (data.error) {
                        result.innerText = "⚠️ " + data.error;
                        btn.disabled = false;
                        document.getElementById("ad-countdown").innerText = "";
                        return;
                    }

                    let rewardText = "🎉 你获得了：" + data.reward.join(" + ") + " 分";
                    let luckyText = "🎫 幸运号码：" + data.lucky_number;
                    result.innerText = rewardText + "\n" + luckyText;

                    cooldown.innerText = "冷却中：" + cooldownSeconds + " 秒";
                    startCooldown(cooldownSeconds);
                });
        }

        function startCooldown(secondsLeft) {
            const cooldownDiv = document.getElementById('cooldown');
            const button = document.getElementById('roll-btn');

            button.disabled = true;
            cooldownDiv.style.display = 'block';

            const interval = setInterval(() => {
                secondsLeft--;
                cooldownDiv.innerText = `冷却中：${secondsLeft} 秒`;

                if (secondsLeft <= 0) {
                    clearInterval(interval);
                    cooldownDiv.style.display = 'none';
                    document.getElementById('result').innerText = '';
                    document.getElementById('ad-countdown').innerText = '';
                    button.disabled = false;
                }
            }, 1000);
        }
    </script>
{% endblock %}
